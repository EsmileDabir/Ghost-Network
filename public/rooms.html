<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Rooms - College Chat</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <h2>Available Chat Rooms</h2>
      <div class="user-info">Welcome, <span id="user-name"></span>! 
        <button onclick="logout()">Logout</button>
      </div>
    </header>

    <div id="admin-options" style="display:none;" class="admin-panel">
      <h3>Admin Options</h3>
      <button onclick="createRoom()" class="admin-btn">Create New Room</button>
    </div>

    <div class="room-list">
      <h3>Active Rooms</h3>
      <div id="rooms-container">
        <p>Loading rooms...</p>
      </div>
    </div>

    <div class="join-section">
      <input type="text" id="roomId" placeholder="Enter Room ID to join" />
      <button onclick="joinRoom()">Join Room</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const userName = sessionStorage.getItem("name");
    const role = sessionStorage.getItem("role");
    const isCreator = sessionStorage.getItem("isCreator") === "true";
    
    if (!userName) {
      window.location.href = "login.html";
    }
    
    document.getElementById("user-name").textContent = userName;
    
    if (role === "admin" || isCreator) {
      document.getElementById("admin-options").style.display = "block";
    }
    
    // Fetch and display rooms
    function loadRooms() {
      fetch('/rooms-api?username=' + encodeURIComponent(userName))
        .then(response => response.json())
        .then(rooms => {
          const container = document.getElementById('rooms-container');
          
          if (rooms.length === 0) {
            container.innerHTML = '<p>No active rooms. Create one as admin!</p>';
            return;
          }
          
          container.innerHTML = rooms.map(room => `
            <div class="room-item ${room.isGlobal ? 'global-room' : ''}">
              <div class="room-info">
                <div class="room-name">${room.name} ${room.isGlobal ? '(Global)' : ''}</div>
                ${!room.isGlobal ? `<div class="room-id">ID: ${room.id}</div>` : ''}
              </div>
              <div class="room-users">
                ${room.userCount} user(s)
                ${room.isGlobal ? 
                  `<button onclick="joinGlobalRoom()">Join</button>` : 
                  `<button onclick="joinSpecificRoom('${room.id}')">Join</button>`
                }
              </div>
            </div>
          `).join('');
        })
        .catch(error => {
          console.error('Error loading rooms:', error);
          document.getElementById('rooms-container').innerHTML = '<p>Error loading rooms</p>';
        });
    }
    
    // Listen for room updates
    socket.on("room-update", (rooms) => {
      const container = document.getElementById('rooms-container');
      
      if (rooms.length === 0) {
        container.innerHTML = '<p>No active rooms. Create one as admin!</p>';
        return;
      }
      
      container.innerHTML = rooms.map(room => `
        <div class="room-item ${room.isGlobal ? 'global-room' : ''}">
          <div class="room-info">
            <div class="room-name">${room.name} ${room.isGlobal ? '(Global)' : ''}</div>
            ${!room.isGlobal ? `<div class="room-id">ID: ${room.id}</div>` : ''}
          </div>
          <div class="room-users">
            ${room.userCount} user(s)
            ${room.isGlobal ? 
              `<button onclick="joinGlobalRoom()">Join</button>` : 
              `<button onclick="joinSpecificRoom('${room.id}')">Join</button>`
            }
          </div>
        </div>
      `).join('');
    });
    
    function createRoom() {
      const randomId = Math.floor(100000 + Math.random() * 900000).toString();
      sessionStorage.setItem("isCreator", "true");
      sessionStorage.setItem("roomId", randomId);
      alert("Room created! Your Room ID (only visible to you): " + randomId);
      window.location.href = `chat.html?room=${randomId}`;
    }
    
    function joinRoom() {
      const room = document.getElementById("roomId").value.trim();
      if (!room) {
        alert("Please enter a room ID");
        return;
      }
      sessionStorage.setItem("isCreator", "false");
      sessionStorage.setItem("fromChat", "true");
      window.location.href = `chat.html?room=${room}`;
    }
    
    function joinSpecificRoom(roomId) {
      sessionStorage.setItem("isCreator", "false");
      sessionStorage.setItem("fromChat", "true");
      window.location.href = `chat.html?room=${roomId}`;
    }
    
    function joinGlobalRoom() {
      sessionStorage.setItem("isCreator", "false");
      sessionStorage.setItem("fromChat", "true");
      window.location.href = `chat.html?room=global-room`;
    }
    
    function logout() {
      sessionStorage.clear();
      window.location.href = "login.html";
    }
    
    // Load rooms on page load
    window.onload = function() {
      loadRooms();
      
      if (sessionStorage.getItem("fromChat")) {
        sessionStorage.removeItem("fromChat");
        window.history.pushState(null, document.title, window.location.href);
        window.addEventListener('popstate', function(event) {
          window.history.pushState(null, document.title, window.location.href);
          alert("Please use the Logout button instead of browser navigation.");
        });
      }
    };

    // Theme switcher code (same as before)
    document.addEventListener('DOMContentLoaded', function() {
      const styleSwitcher = document.createElement('div');
      styleSwitcher.className = 'style-switcher';
      styleSwitcher.innerHTML = `
        <h4>THEME STYLE</h4>
        <div class="style-options">
          <button class="style-btn active" data-theme="elegant" title="Elegant">ðŸŽ©</button>
          <button class="style-btn" data-theme="midnight" title="Midnight">ðŸŒ™</button>
          <button class="style-btn" data-theme="ghostly" title="Ghostly">ðŸ‘»</button>
        </div>
      `;
      document.body.appendChild(styleSwitcher);

      document.body.className = 'theme-elegant';
      
      const styleButtons = document.querySelectorAll('.style-btn');
      styleButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const theme = this.getAttribute('data-theme');
          document.body.className = `theme-${theme}`;
          styleButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          localStorage.setItem('ghostroom-theme', theme);
        });
      });
      
      const savedTheme = localStorage.getItem('ghostroom-theme') || 'elegant';
      document.body.className = `theme-${savedTheme}`;
      document.querySelector(`[data-theme="${savedTheme}"]`).classList.add('active');
    });
  </script>
</body>
</html>